## Set up
```{r additional libraries}
library(zoo)
library(gridExtra)
library(cowplot)

```

```{r set up}
source("~/R_code_github/useful_functions_module.r")
my_paths <- set_work_dir()
root.dir <- my_paths
source("~/R_code_github/quantify_compliance/get_data.R")

```
```{r}
glimpse(compl_clean)
# Rows: 167,607
# Columns: 21

```
## Separate SA and GOM permits

```{r get list of all permitgroups}
# https://www.fisheries.noaa.gov/southeast/recreational-fishing/frequently-asked-questions-southeast-hire-integrated-electronic#general-program-requirements

# GOM: RCG, HRCG, CHG, HCHG
# SA:  CDW, CHS, SC

```
```{r separate into 2 groups: SA vs GOM + dual}
compl_clean_sa_vs_gom_plus_dual_0 <-
  compl_clean %>%
  mutate(permit =
           case_when(
             !grepl("RCG|HRCG|CHG|HCHG", permitgroup) ~ "sa_only",
             .default = "gom"
           ))

glimpse(compl_clean_sa_vs_gom_plus_dual_0)
```
```{r add columns for month and quarter}
compl_clean_sa_vs_gom_plus_dual <-
  compl_clean_sa_vs_gom_plus_dual_0 %>%
  # add month
  mutate(year_month = as.yearmon(week_start)) %>%
  # add quarter
  mutate(year_quarter = as.yearqtr(week_start))

glimpse(compl_clean_sa_vs_gom_plus_dual)
```

### View fewer columns for a test
```{r view fewer columns}

compl_clean_sa_vs_gom_plus_dual %>%
  select(vessel_official_number, compliant_, week, permit, year_month, year) %>%
  head()

```

## Percentage

From Michelle:
Can we make the titles, “weekly compliance Gulf and dual permitted”, “monthly compliance Gulf and dual permitted”, “annual compliance Gulf and dual permitted”, and then the same for SA. So 6 total figures.

Oh, and show it not as a number but a proportion. So, if we were looking at Gulf weekly compliance and it was 50 compliant vessels and 50 non-compliant, then the figures would be showing bars for 50% compliant and 50% non compliant. (50/100*100= 50%)

We don’t want to sum the entries though. We just need to know vessel level compliance, weekly, monthly and annually.  How many vessels by gulf and SA. The file you have lists the compliance by vessel and permit type, so you’ll just need to analyze it that way.

### Prepare compliance info

#### Get only the columns we need
```{r Prepare compliance info}
compl_clean_sa_vs_gom_plus_dual_short <-
  compl_clean_sa_vs_gom_plus_dual %>%
  select(
    vessel_official_number,
    compliant_,
    permit,
    week_start,
    year_month,
    year_quarter,
    year
  )

head(compl_clean_sa_vs_gom_plus_dual_short)
```

#### Create 2 new dfs for SA and GOM + dual permit groups
```{r}
gom_compl_clean_sa_vs_gom_plus_dual_short <-
  filter(compl_clean_sa_vs_gom_plus_dual_short, permit == "gom")
sa_compl_clean_sa_vs_gom_plus_dual_short <-
  filter(compl_clean_sa_vs_gom_plus_dual_short, permit == "sa_only")
```

#### an auxilary function
```{r my_percent fun}
my_percent <- function(x, y) {
  # y : 100%
  # x : b%
  return(x * 100 / y)
}

```

```{r GOM + dual}
gom_compl_clean_sa_vs_gom_plus_dual_short %>%
  group_by(vessel_official_number, compliant_, week_start) %>%
  summarise(n = n()) %>%
  summarise(by_week = sum(n)) %>%
  head()

gom_compl_clean_sa_vs_gom_plus_dual_short %>%
  filter(week_start == "2022-12-26") %>%
  # select(vessel_official_number) %>% unique() %>%
  # Rows: 1,114
  count(compliant_) %>%
  # count(gom_w_start_compl, week_start, compliant)
  glimpse()
# 1067 + 47 : 100
# 1067      : b

# (1067 * 100) / (1067 + 47)
# [1] 95.78097

# gom_compl_clean_sa_vs_gom_plus_dual_short %>%
#   add_count(vessel_official_number, name = 'count') %>%
#   group_by(vessel_official_number) %>%
#   mutate(percent_yes = 100 * mean(compliant_),
#          percent_no = 100 - percent_yes) %>%  head()
# ungroup

gom_compl_clean_sa_vs_gom_plus_dual_short %>%
  summarize(
    count = n(),
    percent_yes = my_percent(sum(compliant_ == "YES"), count),
    percent_no = my_percent(sum(compliant_ == "NO"), count)
  ) %>% head()

gom_compl_clean_sa_vs_gom_plus_dual_short %>%
  group_by(week_start) %>%
  summarize(
    count = n(),
    percent_yes = my_percent(sum(compliant_ == "YES"), count),
    percent_no = my_percent(sum(compliant_ == "NO"), count)
  ) %>%
  filter(week_start == "2022-12-26") %>%
  head()
# week_start count percent_yes percent_no
# <date>     <int>       <dbl>      <dbl>
# 2022-12-26  1114        95.8       4.22


gom_per_week <-
  gom_compl_clean_sa_vs_gom_plus_dual_short %>%
  group_by(week_start) %>%
  summarize(
    count = n(),
    percent_yes = my_percent(sum(compliant_ == "YES"), count),
    percent_no = my_percent(sum(compliant_ == "NO"), count)
  )

# str(gom_per_week)
# tibble [60 × 4] (S3: tbl_df/tbl/data.frame)

gom_per_month <-
  gom_compl_clean_sa_vs_gom_plus_dual_short %>%
  group_by(year_month) %>%
  summarize(
    count = n(),
    percent_yes = my_percent(sum(compliant_ == "YES"), count),
    percent_no = my_percent(sum(compliant_ == "NO"), count)
  )

str(gom_per_month)

gom_per_year <-
  gom_compl_clean_sa_vs_gom_plus_dual_short %>%
  group_by(year) %>%
  summarize(
    count = n(),
    percent_yes = my_percent(sum(compliant_ == "YES"), count),
    percent_no = my_percent(sum(compliant_ == "NO"), count)
  )

gom_per_year
# 96.9/3.15 = 30.7619 = (sum(yes) / sum(no))

```
```{r SA only}
percent_by_time_period <- function(my_df, time_period_field_name) {
  my_df %>%
    group_by(!!sym(time_period_field_name)) %>%
    summarize(
      count = n(),
      percent_yes = my_percent(sum(compliant_ == "YES"), count),
      percent_no = my_percent(sum(compliant_ == "NO"), count)
    ) %>%
    return()
}

compl_clean_sa_vs_gom_plus_dual %>%
  filter(permit == "sa_only") %>%
  select(vessel_official_number, compliant_, week, year) %>%
  arrange(vessel_official_number, year, week) %>%
  tail()
sa_per_year <-
  percent_by_time_period(sa_compl_clean_sa_vs_gom_plus_dual_short, "year")

sa_per_month <-
  percent_by_time_period(sa_compl_clean_sa_vs_gom_plus_dual_short, "year_month")

sa_per_week <-
  percent_by_time_period(sa_compl_clean_sa_vs_gom_plus_dual_short, "week_start")

# test
# sa_per_week %>%
# filter(week_start == "2022-12-26")

# sa_compl_clean_sa_vs_gom_plus_dual_short %>%
# filter(week_start == "2022-12-26") %>%
# group_by(compliant_, week_start) %>%
# summarise(n = n())

# my_percent(953, (684+953))
# 58.21625

```
```{r plots for percentage}

# sa_per_year_long <-
#   sa_per_year %>%
#   pivot_longer(starts_with("percent"),
#                names_to = "key",
#                values_to = "percent")

# my_df <- sa_per_year_long
# time_period <- "year"
my_region <- c("Gulf and dual", "South Atlantic")

my_colors <- c("red", "blue")

cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

percent_plot <- function(my_df, time_period, region) {
  percent_p <-
    my_df %>%
    pivot_longer(starts_with("percent"),
                 names_to = "key",
                 values_to = "percent") %>%
    ggplot(aes(
      x = !!sym(time_period),
      y = percent,
      fill = key
    ))
  
  my_title <- case_when(
    time_period == "year" ~ "Annual",
    time_period == "year_month" ~ "Monthly",
    time_period == "week_start" ~ "Weekly"
  )
  
  my_x_lab <- case_when(
    time_period == "year" ~ "year",
    time_period == "year_month" ~ "month",
    time_period == "week_start" ~ "week"
  )
  
  percent_p + geom_bar(position = "dodge", stat = "identity") +
    labs(
      title = paste0(my_title, " compliance"),
      # title = paste0(my_title, " compliance ",  region, " permitted"),
      y = "",
      x = my_x_lab
    ) +
    # scale_fill_manual(values = cbbPalette) +
    scale_fill_manual(values = my_colors,
                      name = "Colors",
                      labels = c("% non-compliant", "% compliant")) +
    theme(axis.text.x = element_text(angle = 45)) +
    ylim(0, 100) %>%
    return()
}
sa_per_year_p <- percent_plot(sa_per_year, "year", my_region[[2]])
sa_per_month_p <- percent_plot(sa_per_month, "year_month", my_region[[2]])
sa_per_week_p <- percent_plot(sa_per_week, "week_start", my_region[[2]])

gom_per_year_p <- percent_plot(gom_per_year, "year", my_region[[1]])
gom_per_month_p <- percent_plot(gom_per_month, "year_month", my_region[[1]])
gom_per_week_p <- percent_plot(gom_per_week, "week_start", my_region[[1]])

legend <-
  cowplot::get_legend(gom_per_week_p + theme(legend.position = "right"))

region <- my_region[[2]]
# sa_all <-
grid.arrange(
  sa_per_week_p + theme(legend.position = 'hidden'),
  sa_per_month_p + theme(legend.position = 'hidden'),
  sa_per_year_p + theme(legend.position = 'hidden'),
  legend,
  nrow = 2,
  top = paste0(region, " permitted"),
  left = "YES and NO percentage"
  # ,
  # right = legend
)

region <- my_region[[1]]
grid.arrange(
  gom_per_week_p + theme(legend.position = 'hidden'),
  gom_per_month_p + theme(legend.position = 'hidden'),
  gom_per_year_p + theme(legend.position = 'hidden') + 
    geom_text(aes(label = round(percent, 2)),
              position = position_dodge(width = 0.9),
              vjust = -0.25),
  legend,
  nrow = 2,
  top = paste0(region, " permitted"),
  left = "YES and NO percentage"
  # ,
  # right = legend
)

sa_per_year
```

```{r compliance numbers by permit group and time period}
by_week <-
  compl_clean_sa_vs_gom_plus_dual %>%
  group_by(permit,
           compliant_,
           week) %>%
  summarise(n = n())
str(by_week)
# gropd_df [240 × 4] (S3: grouped_df/tbl_df/tbl/data.frame)

```
```{r by month}
compl_clean_sa_vs_gom_plus_dual__months <-
  compl_clean_sa_vs_gom_plus_dual %>%
  mutate(
    month_w_start = format(week_start, "%m"),
    month_w_end = format(week_end, "%m"),
    year_month_w_start = floor_date(week_start),
    year_month_w_end = floor_date(week_end)
  )

by_month_w_start <-
  compl_clean_sa_vs_gom_plus_dual__months %>%
  group_by(permit,
           month_w_start) %>%
  summarise(compl_by_not = (sum(tolower(compliant_) == "yes")) /
              (sum(tolower(compliant_) == "no")))
str(by_month_w_start)

by_month_w_end <-
  compl_clean_sa_vs_gom_plus_dual__months %>%
  group_by(permit,
           month_w_end) %>%
  summarise(compl_by_not = (sum(tolower(compliant_) == "yes")) /
              (sum(tolower(compliant_) == "no")))

str(by_month_w_end)
setdiff(by_month_w_start$compl_by_not, by_month_w_end$compl_by_not)
# 24
setdiff(by_month_w_end$compl_by_not, by_month_w_start$compl_by_not)

```
