# this file is called from quantify_compliance.R

# files to upload:
# FHIER_Compliance_2023__01_24_2023.csv (from FHIER / compliance report)
# FHIER_Compliance_2022__02_05_2024.csv (from FHIER / compliance report)

# Compliance_Error_Types_03_29_2023.csv

# Processed Metrics tracking
# SEFHIER_permitted_vessels_nonSRHS_{my_year}

# "C:\Users\anna.shipunova\Documents\R_files_local\my_inputs\processing_logbook_data\Outputs\SEFHIER_processed_Logbooks_2022.rds"

project_dir_name <- "FHIER Compliance"

# Download files from FHIER / Reports / FHIER COMPLIANCE REPORT
# get data from csvs ----
get_data_from_FHIER_csvs <- function() {

  filenames = c(
    r"(2024_02_05\FHIER_Compliance_2022__02_05_2024.csv)",
    r"(2024_01_24\FHIER_Compliance_2023__01_24_2024.csv)"
  )

  ## ---- get csv data into variables ----
  csv_names_list <- prepare_csv_names(filenames)

  # read all csv files
  csv_contents <- load_csv_names(my_paths, csv_names_list)

  # unify headers, trim vesselofficialnumber, just in case
  csvs_clean1 <- clean_all_csvs(csv_contents)
  compl_clean <- compliance_cleaning(csvs_clean1)

  return(compl_clean)
}

# Define a function named 'get_compliance_error_definitions' with no parameters
get_compliance_error_definitions <- function() {
  
  # Create a character vector 'err_desc_filenames' containing the file path
  err_desc_filenames = c(file.path(project_dir_name, "Compliance_Error_Types_03_29_2023.csv"))
  
  # Load the contents of the CSV file specified in 'err_desc_filenames' using 'load_csv_names' and 'my_paths'
  err_desc_csv_contents <- load_csv_names(my_paths, err_desc_filenames)
  
  # Clean the headers of the loaded CSV content using 'clean_headers'
  err_desc_clean_headers_csv_content <-
    clean_headers(err_desc_csv_contents[[1]])
  
  # Convert a specific column ("last_updated") to date format using 'change_to_dates'
  err_desc <-
    change_to_dates(err_desc_clean_headers_csv_content,
                    "last_updated",
                    "%m/%d/%Y %I:%M:%S %p")
  
  # Return the cleaned and processed data frame 'err_desc'
  return(err_desc)
}

get_data_from_csv <- function() {
  # uncomment to run
  # browser()

  compl_clean <- get_data_from_FHIER_csvs()
  
  if (class(compl_clean) == "list" &
      length(compl_clean) == 1) {
    compl_clean <- compl_clean[[1]]
  }
  # View(compl_clean)
  
  ## get compliance error definitions from csvs ----
  err_desc <- get_compliance_error_definitions()
  
  # Check the result is a single dataframe, and if not, combine separate dataframes for all years into one.
  if (length(compl_clean) > 1) {
    compl_clean_1 <- join_same_kind_csvs(compl_clean)
  }

  dim(compl_clean_1)
  # [1] 296294     20
  
  compl_clean_2 <- additional_clean_up(compl_clean_1)

  cat("compl_clean_sa_vs_gom_m_int_c")  
  return(compl_clean_2)
}

additional_clean_up <- function(compl_clean) {
  
  # add columns for month and quarter
  compl_clean_sa_vs_gom_m <- compl_clean_sa_vs_gom %>%
    # Add a new column 'year_month' by extracting the year and month from the 'week_start' column
    dplyr::mutate(year_month = zoo::as.yearmon(week_start)) %>%
    # Add another new column 'year_quarter' by extracting the year and quarter from the 'week_start' column
    dplyr::mutate(year_quarter = zoo::as.yearqtr(week_start))
  
  # convert report numbers to numeric
  # Create a new data frame 'compl_clean_sa_vs_gom_m_int' by applying integer conversion to selected columns in 'compl_clean_sa_vs_gom_m'.
  compl_clean_sa_vs_gom_m_int <- compl_clean_sa_vs_gom_m %>%
    dplyr::mutate(
      captainreports__ = as.integer(captainreports__),
      negativereports__ = as.integer(negativereports__),
      gom_permitteddeclarations__ = as.integer(gom_permitteddeclarations__)
    )

  return(compl_clean_sa_vs_gom_m_int)
}

# Uncomment and run above functions if using csvs downloaded from FHIER
tic("get_data_from_csv")
compl_clean_sa_vs_gom_m_int_c <- get_data_from_csv()
toc()

# compl_clean_sa_vs_gom_m_int_c <-
#   add_year_permit_col(compl_clean_sa_vs_gom_m_int)

# get_permit_data_from_metrics_tracking ----
processed_metrics_tracking_path <- 
  file.path(my_paths$inputs,
            "processing_logbook_data",
            "Outputs")
# dir.exists(processed_metrics_tracking_path)
# T  

processed_metrics_tracking_file_names <-
  list.files(path = processed_metrics_tracking_path,
             pattern = "SEFHIER_permitted_vessels_nonSRHS_*",
             recursive = TRUE)

View(processed_metrics_tracking_file_names)

# SEFHIER_permitted_vessels_nonSRHS_2022.rds
  
# "C:\Users\anna.shipunova\Documents\R_files_local\my_inputs\processing_logbook_data\Outputs\SEFHIER_permitted_vessels_nonSRHS_2022.rds"


# get data from db ----
file.path(my_paths$git_r, r"(get_data\get_db_data\get_db_data.R)") |>
  source()

tic("run_all_get_db_data()")
all_get_db_data_result_l <- run_all_get_db_data()
toc()
# run_all_get_db_data(): 13.61 sec elapsed

# View(all_get_db_data_result_l)

# get processed logbook data ----

processed_logbooks_file_names <- 
  c("SEFHIER_usable_Logbooks_2022.rds",
    "SEFHIER_usable_Logbooks_2023.rds")
  
processed_logbooks_dir_path <- 
  file.path(my_paths$inputs,
  r"(processing_logbook_data\Outputs)")

processed_logbooks <- 
  processed_logbooks_file_names |> 
  map_df(\(file_name) {
    my_file_path <- 
      file.path(processed_logbooks_dir_path,
                file_name)
    read_rds(my_file_path)
  })

# results:
# all_get_db_data_result_l
# processed_logbooks
